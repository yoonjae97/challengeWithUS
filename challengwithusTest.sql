insert into members(MemberId, MemberPwd, MemberEmail, MemberName, MemberGradeName, MemberDeposit ) 
values ('yjkim', 1234, 'test1@naver.com',	'yjkim', 'new',	5000);
insert into members(MemberId, MemberPwd, MemberEmail, MemberName, MemberGradeName, MemberDeposit) 
values ('hkchoi', 1234, 'test2@naver.com', 'hkchoi', 'new', 5000);
insert into members(MemberId, MemberPwd, MemberEmail, MemberName, MemberGradeName, MemberDeposit) 
values ('mkseo', 1234, 'test3@naver.com', 'mkseo', 'new',	5000);
insert into members(MemberId, MemberPwd, MemberEmail, MemberName, MemberGradeName, MemberDeposit) 
values ('hjcho', 1234, 'test4@naver.com', 'hjcho', 'new', 5000);
insert into members(MemberId, MemberPwd, MemberEmail, MemberName, MemberGradeName, MemberDeposit) 
values ('yjhwang', 1234, 'test5@naver.com', 'yjhwang', 'new', 5000);
insert into members(MemberId, MemberPwd, MemberEmail, MemberName, MemberGradeName, MemberDeposit) 
values ('swchoi', 1234, 'test6@naver.com',	'swchoi', 'new',	5000);

insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/02 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/03 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/04 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/05 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/06 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/07 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/08 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/09 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjkim', '2023/07/10 00:00', 3);

insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/02 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/03 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/04 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/05 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/06 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/07 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/08 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/09 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hkchoi', '2023/07/10 00:00', 3);

insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'mkseo', '2023/07/02 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'mkseo', '2023/07/03 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'mkseo', '2023/07/04 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'mkseo', '2023/07/05 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'mkseo', '2023/07/06 00:00', 3);

insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hjcho', '2023/07/02 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hjcho', '2023/07/03 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hjcho', '2023/07/04 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hjcho', '2023/07/05 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hjcho', '2023/07/06 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hjcho', '2023/07/07 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hjcho', '2023/07/08 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'hjcho', '2023/07/09 00:00', 3);

insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjhwang', '2023/07/02 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjhwang', '2023/07/03 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjhwang', '2023/07/04 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjhwang', '2023/07/05 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjhwang', '2023/07/06 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjhwang', '2023/07/07 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjhwang', '2023/07/08 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'yjhwang', '2023/07/09 00:00', 3);

insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'swchoi', '2023/07/02 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'swchoi', '2023/07/03 00:00', 3);
insert into ChalParticipantLogs values(chalauthno_seq.nextval, 'swchoi', '2023/07/04 00:00', 3);

insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'yjkim', 10000, '2023/06/30 00:00', '예치금 충전', 10000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'hkchoi', 10000, '2023/06/30 00:00', '예치금 충전', 10000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'mkseo', 10000, '2023/06/30 00:00', '예치금 충전', 10000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'hjcho', 10000, '2023/06/30 00:00', '예치금 충전', 10000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'yjhwang', 10000, '2023/06/30 00:00', '예치금 충전', 10000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'swchoi', 10000, '2023/06/30 00:00', '예치금 충전', 10000); 

insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'yjkim', -5000, '2023/07/01 00:00', '챌린지 참여', 5000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'hkchoi', -5000, '2023/07/01 00:00', '챌린지 참여', 5000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'mkseo', -5000, '2023/07/01 00:00', '챌린지 참여', 5000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'hjcho', -5000, '2023/07/01 00:00', '챌린지 참여', 5000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'yjhwang', -5000, '2023/07/01 00:00', '챌린지 참여', 5000); 
insert into DepositTransactions 
values(DepositTransNo_seq.nextval, 'swchoi', -5000, '2023/07/01 00:00', '챌린지 참여', 5000);

BEGIN
  PROCESS_CHAL_DEPO_PROC;
END;
drop procedure PROCESS_CHAL_DEPO_PROC;
CREATE OR REPLACE PROCEDURE PROCESS_CHAL_DEPO_PROC AS
  v_chal_no Challenges.chalno%TYPE;
  v_chal_fee Challenges.chalfee%TYPE;
  v_success_participants_85 Challenges.successparticipants85%TYPE;
  v_success_participants_100 Challenges.successparticipants100%TYPE;
  v_total_fee Challenges.chaltotalfee%TYPE;
  v_return_amount Challenges.chaltotalfee%TYPE;
BEGIN
  FOR chal_rec IN (SELECT chalno, chalfee, successparticipants85, successparticipants100, chaltotalfee
                   FROM challenges
                   WHERE chalstatus = '1'
                   AND chalenddate <= SYSDATE) -- Consider only active challenges that have ended
  LOOP
    v_chal_no := chal_rec.chalno;
    v_chal_fee := chal_rec.chalfee;
    v_success_participants_85 := chal_rec.successparticipants85;
    v_success_participants_100 := chal_rec.successparticipants100;
    v_total_fee := chal_rec.chaltotalfee;
    
    -- Calculate the return amount per 100% achiever
    v_return_amount := (v_total_fee - (v_success_participants_85 * v_chal_fee)) / v_success_participants_100;
    
    -- Process 85% <= AchievementRate < 100%
    FOR ach_rec IN (SELECT ma.memberid, ma.achievementrate
                    FROM memberachievement ma
                    WHERE ma.chalno = v_chal_no
                      AND ma.achievementrate >= 85
                      AND ma.achievementrate < 100)
    LOOP
      UPDATE members m
      SET m.memberdeposit = m.memberdeposit + v_chal_fee
      WHERE m.memberid = ach_rec.memberid;
      
      -- Insert into deposittransactions table for 85% <= AchievementRate < 100%
      INSERT INTO deposittransactions (deposittransno, memberid, depositamount, depositcontent, depositbalance)
      SELECT deposittransno_seq.NEXTVAL, ach_rec.memberid, v_chal_fee, '챌린지 성공 보상', m.memberdeposit
      FROM members m
      WHERE m.memberid = ach_rec.memberid;
    END LOOP;
    
    -- Process 100% AchievementRate
    FOR ach_rec IN (SELECT ma.memberid, ma.achievementrate
                    FROM memberachievement ma
                    WHERE ma.chalno = v_chal_no
                      AND ma.achievementrate >= 100)
    LOOP
      UPDATE members m
      SET m.memberdeposit = m.memberdeposit + v_return_amount
      WHERE m.memberid = ach_rec.memberid;
      
      -- Insert into deposittransactions table for 100% AchievementRate
      INSERT INTO deposittransactions (deposittransno, memberid, depositamount, depositcontent, depositbalance)
      SELECT deposittransno_seq.NEXTVAL, ach_rec.memberid, v_return_amount, '챌린지 100% 성공 보상', m.memberdeposit
      FROM members m
      WHERE m.memberid = ach_rec.memberid;
    END LOOP;
    
    -- Set challenge status to 0 after distributing deposits
    UPDATE challenges
    SET chalstatus = '0'
    WHERE chalno = v_chal_no;
  END LOOP;
  
  COMMIT;
EXCEPTION
  WHEN OTHERS THEN
    ROLLBACK;
    RAISE;
END;
/

select * from challenges where chalno=3;